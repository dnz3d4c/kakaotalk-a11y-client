# 카카오톡 접근성 클라이언트 - 디버그 모드 도구 통합 프롬프트

**목적**: 디버그 모드에서 UIA 분석 도구들이 상황에 맞게 자동 실행되도록 통합  
**대상**: Claude Code  
**전제**: UIA Inspector, Event Monitor, Profiler, Log Analyzer 도구 개발 완료

---

## 배경

현재 개발된 UIA 분석 도구들:
- `UIAInspector`: 카카오톡 트리 덤프, 비교, 실시간 인스펙션
- `UIAEventMonitor`: 카카오톡 이벤트 모니터링
- `UIAProfiler`: 성능 프로파일링
- `ProfileAnalyzer`: 로그 분석 및 리포트

이 도구들을 개별 실행할 수도 있지만, **디버그 모드(`--debug`)로 클라이언트 실행 시 상황에 맞게 자동으로 활용**되도록 통합하고자 함.

---

## 목표

```
[일반 모드]
$ python -m kakaotalk_a11y_client.main
→ 도구 비활성, 최소 로깅

[디버그 모드]  
$ python -m kakaotalk_a11y_client.main --debug
→ 상황별 도구 자동 실행, 상세 로깅, 문제 발생 시 자동 덤프
```

---

## Phase 1: 디버그 모드 인프라 구축

### 1.1 디버그 설정 관리

```python
# config.py 또는 utils/debug_config.py

"""
디버그 모드 설정 관리

사용:
    from utils.debug_config import debug_config
    
    if debug_config.enabled:
        # 디버그 전용 로직
"""

from dataclasses import dataclass, field
from typing import Set
from pathlib import Path


@dataclass
class DebugConfig:
    """디버그 모드 설정"""
    
    # 기본 설정
    enabled: bool = False
    
    # 도구별 활성화 (세분화 제어)
    enable_profiler: bool = True
    enable_inspector: bool = True
    enable_event_monitor: bool = False  # 기본 비활성 (오버헤드)
    enable_auto_dump: bool = True
    
    # 자동 덤프 트리거 조건
    auto_dump_on_error: bool = True
    auto_dump_on_slow: bool = True
    slow_threshold_ms: float = 500  # 이 시간 초과 시 자동 덤프
    
    # 로깅 레벨
    log_level: str = 'DEBUG'  # 일반 모드는 'INFO'
    
    # 출력 디렉토리
    debug_output_dir: Path = field(
        default_factory=lambda: Path.home() / '.kakaotalk_a11y' / 'debug'
    )
    
    # 활성화된 자동 분석 시나리오
    auto_analyze_scenarios: Set[str] = field(default_factory=lambda: {
        # 'menu_fail',    # [폐기됨] 컨텍스트 메뉴 - NVDA 네이티브 동작에 위임
        'empty_list',     # 빈 리스트 감지 시
        'focus_lost',     # 포커스 유실 시
        'slow_operation', # 느린 작업 감지 시
    })


# 전역 인스턴스
debug_config = DebugConfig()


def init_debug_mode(
    enabled: bool = True,
    **kwargs
):
    """
    디버그 모드 초기화
    
    Args:
        enabled: 디버그 모드 활성화
        **kwargs: DebugConfig 필드 오버라이드
    """
    global debug_config
    debug_config.enabled = enabled
    
    for key, value in kwargs.items():
        if hasattr(debug_config, key):
            setattr(debug_config, key, value)
    
    if enabled:
        debug_config.debug_output_dir.mkdir(parents=True, exist_ok=True)
```

### 1.2 CLI 인자 처리

```python
# main.py 수정

import argparse
from utils.debug_config import init_debug_mode, debug_config


def parse_args():
    parser = argparse.ArgumentParser(
        description='카카오톡 접근성 클라이언트'
    )
    
    # 디버그 옵션
    parser.add_argument(
        '--debug', '-d',
        action='store_true',
        help='디버그 모드 활성화 (상세 로깅, 자동 분석)'
    )
    
    parser.add_argument(
        '--debug-profile',
        action='store_true',
        help='프로파일러만 활성화'
    )
    
    parser.add_argument(
        '--debug-events',
        action='store_true',
        help='이벤트 모니터 활성화 (오버헤드 주의)'
    )
    
    parser.add_argument(
        '--debug-dump-on-start',
        action='store_true',
        help='시작 시 카카오톡 트리 덤프'
    )
    
    return parser.parse_args()


def main():
    args = parse_args()
    
    # 디버그 모드 초기화
    if args.debug:
        init_debug_mode(
            enabled=True,
            enable_event_monitor=args.debug_events,
        )
        print("[DEBUG] 디버그 모드 활성화")
    elif args.debug_profile:
        init_debug_mode(
            enabled=True,
            enable_inspector=False,
            enable_event_monitor=False,
        )
        print("[DEBUG] 프로파일러 전용 모드")
    
    # 시작 시 덤프
    if args.debug_dump_on_start:
        from utils.uia_inspector import UIAInspector
        inspector = UIAInspector()
        dump_path = inspector.dump_to_file(filename_prefix='startup')
        print(f"[DEBUG] 시작 덤프 저장: {dump_path}")
    
    # ... 나머지 초기화 ...
```

---

## Phase 2: 상황별 자동 도구 실행

### 2.1 디버그 컨텍스트 매니저

```python
# utils/debug_tools.py

"""
디버그 도구 통합 관리

목적:
- 상황에 맞는 도구 자동 실행
- 에러/느린 작업 발생 시 자동 덤프
- 디버그 정보 일관된 수집
"""

from contextlib import contextmanager
from typing import Optional, Callable
from datetime import datetime
from pathlib import Path
import traceback

from utils.debug_config import debug_config
from utils.profiler import profiler
from utils.uia_inspector import UIAInspector, KakaoNotFoundError


class DebugToolManager:
    """디버그 도구 통합 관리자"""
    
    def __init__(self):
        self._inspector: Optional[UIAInspector] = None
        self._session_id = datetime.now().strftime('%Y%m%d_%H%M%S')
    
    @property
    def inspector(self) -> UIAInspector:
        """지연 초기화된 Inspector"""
        if self._inspector is None:
            self._inspector = UIAInspector(profiler=profiler)
        return self._inspector
    
    @contextmanager
    def debug_operation(
        self,
        operation_name: str,
        auto_dump_on_error: bool = True,
        auto_dump_on_slow: bool = True
    ):
        """
        디버그 작업 컨텍스트
        
        사용:
            with debug_tools.debug_operation('open_menu'):
                menu.open()
        
        동작:
            - 작업 시간 측정 (프로파일러 연동)
            - 에러 발생 시 자동 트리 덤프
            - 느린 작업 시 자동 트리 덤프
        """
        if not debug_config.enabled:
            yield
            return
        
        start_time = datetime.now()
        error_occurred = False
        
        try:
            with profiler.measure(operation_name):
                yield
        except Exception as e:
            error_occurred = True
            
            if auto_dump_on_error and debug_config.auto_dump_on_error:
                self._auto_dump(
                    trigger=f'error_{operation_name}',
                    context={
                        'operation': operation_name,
                        'error': str(e),
                        'traceback': traceback.format_exc()
                    }
                )
            raise
        finally:
            elapsed_ms = (datetime.now() - start_time).total_seconds() * 1000
            
            # 느린 작업 덤프
            if (not error_occurred and 
                auto_dump_on_slow and 
                debug_config.auto_dump_on_slow and
                elapsed_ms > debug_config.slow_threshold_ms):
                
                self._auto_dump(
                    trigger=f'slow_{operation_name}',
                    context={
                        'operation': operation_name,
                        'elapsed_ms': elapsed_ms,
                        'threshold_ms': debug_config.slow_threshold_ms
                    }
                )
    
    def _auto_dump(self, trigger: str, context: dict):
        """자동 덤프 실행"""
        try:
            timestamp = datetime.now().strftime('%H%M%S')
            filename = f'auto_{trigger}_{timestamp}'
            
            dump_path = self.inspector.dump_to_file(
                filename_prefix=filename,
                include_coords=True
            )
            
            # 컨텍스트 정보도 저장
            context_path = dump_path.with_suffix('.context.json')
            import json
            context_path.write_text(
                json.dumps(context, indent=2, ensure_ascii=False),
                encoding='utf-8'
            )
            
            print(f"[DEBUG] 자동 덤프: {dump_path}")
        except KakaoNotFoundError:
            print("[DEBUG] 자동 덤프 실패: 카카오톡 창 없음")
        except Exception as e:
            print(f"[DEBUG] 자동 덤프 실패: {e}")
    
    def dump_on_condition(
        self,
        condition_name: str,
        condition_met: bool,
        context: Optional[dict] = None
    ):
        """
        조건부 덤프
        
        사용:
            debug_tools.dump_on_condition(
                'empty_list',
                len(items) == 0,
                {'expected_min': 1}
            )
        """
        if not debug_config.enabled:
            return
        
        if not condition_met:
            return
        
        if condition_name not in debug_config.auto_analyze_scenarios:
            return
        
        self._auto_dump(
            trigger=condition_name,
            context=context or {}
        )
    
    def log_debug(self, message: str, **kwargs):
        """디버그 로그 (디버그 모드에서만)"""
        if debug_config.enabled:
            extra = ' | '.join(f'{k}={v}' for k, v in kwargs.items())
            print(f"[DEBUG] {message}" + (f" | {extra}" if extra else ""))


# 전역 인스턴스
debug_tools = DebugToolManager()
```

### 2.2 시나리오별 자동 실행 통합

```python
# 각 모듈에 디버그 도구 통합 예시

# [폐기됨] navigation/context_menu.py - NVDA 네이티브 동작에 위임
# 아래 코드는 참고용 과거 설계안입니다.
# from utils.debug_tools import debug_tools
# from utils.debug_config import debug_config


class ContextMenuNavigator:  # [폐기됨]
    
    def open_menu(self, target_control) -> bool:
        """컨텍스트 메뉴 열기"""
        
        with debug_tools.debug_operation('context_menu.open'):
            target_control.RightClick()
            time.sleep(0.2)
            
            menu = self._find_menu()
            
            # 메뉴 찾기 실패 시 자동 덤프
            debug_tools.dump_on_condition(
                'menu_fail',
                menu is None,
                {
                    'target_name': target_control.Name,
                    'target_class': target_control.ClassName,
                    'retry_count': self._retry_count
                }
            )
            
            return menu is not None


# navigation/chat_list.py
from utils.debug_tools import debug_tools


class ChatListNavigator:
    
    def get_chat_items(self) -> list:
        """채팅 목록 아이템 가져오기"""
        
        with debug_tools.debug_operation('chat_list.get_items'):
            items = self._fetch_items()
            
            # 빈 리스트 감지
            debug_tools.dump_on_condition(
                'empty_list',
                len(items) == 0,
                {'list_name': 'chat_list'}
            )
            
            # 빈 항목 비율 로깅
            empty_count = sum(1 for i in items if not i.Name)
            debug_tools.log_debug(
                'chat_list items',
                total=len(items),
                empty=empty_count,
                valid=len(items) - empty_count
            )
            
            return items


# core/focus_monitor.py
from utils.debug_tools import debug_tools


class FocusMonitor:
    
    def check_focus(self):
        """포커스 확인"""
        
        current = self._get_current_focus()
        
        # 포커스 유실 감지
        if self._expected_focus and current != self._expected_focus:
            debug_tools.dump_on_condition(
                'focus_lost',
                True,
                {
                    'expected': str(self._expected_focus),
                    'actual': str(current)
                }
            )
```

---

## Phase 3: 디버그 세션 리포트

### 3.1 세션 종료 시 자동 리포트

```python
# utils/debug_tools.py 확장

class DebugToolManager:
    # ... 기존 코드 ...
    
    def generate_session_report(self) -> Path:
        """
        디버그 세션 종료 시 리포트 생성
        
        포함 내용:
        - 프로파일러 요약
        - 자동 덤프 목록
        - 에러 발생 내역
        - 느린 작업 통계
        """
        if not debug_config.enabled:
            return None
        
        from utils.profiler import profiler
        
        report_path = (
            debug_config.debug_output_dir / 
            f'session_{self._session_id}_report.md'
        )
        
        report = f"""# 디버그 세션 리포트

## 세션 정보
- 세션 ID: {self._session_id}
- 시작 시각: {self._session_start}
- 종료 시각: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

## 프로파일러 요약
{profiler.get_summary()}

## 자동 덤프 목록
{self._format_dump_list()}

## 발생한 문제
{self._format_issues()}

## 개선 제안
{self._generate_suggestions()}
"""
        
        report_path.write_text(report, encoding='utf-8')
        return report_path
    
    def _format_dump_list(self) -> str:
        """자동 덤프 목록 포맷"""
        dumps = list(debug_config.debug_output_dir.glob(f'auto_*_{self._session_id[:8]}*'))
        if not dumps:
            return "- 자동 덤프 없음"
        
        lines = []
        for dump in sorted(dumps):
            lines.append(f"- {dump.name}")
        return '\n'.join(lines)


# main.py에 종료 훅 추가
import atexit

def main():
    # ... 초기화 ...
    
    if debug_config.enabled:
        # 종료 시 리포트 생성
        atexit.register(lambda: debug_tools.generate_session_report())
    
    # ... 실행 ...
```

### 3.2 실시간 디버그 명령어 (선택사항)

```python
# utils/debug_commands.py

"""
실행 중 디버그 명령어

키보드 단축키로 디버그 도구 즉시 실행:
- Ctrl+Shift+D: 현재 상태 덤프
- Ctrl+Shift+R: 프로파일러 리포트
- Ctrl+Shift+E: 이벤트 모니터 토글
"""

import keyboard
from utils.debug_tools import debug_tools
from utils.debug_config import debug_config


def register_debug_hotkeys():
    """디버그 단축키 등록 (디버그 모드에서만)"""
    
    if not debug_config.enabled:
        return
    
    def on_dump_now():
        """Ctrl+Shift+D: 즉시 덤프"""
        try:
            path = debug_tools.inspector.dump_to_file(
                filename_prefix='manual'
            )
            print(f"[DEBUG] 수동 덤프: {path}")
        except Exception as e:
            print(f"[DEBUG] 덤프 실패: {e}")
    
    def on_show_profile():
        """Ctrl+Shift+R: 프로파일 요약"""
        from utils.profiler import profiler
        print("\n" + "="*50)
        print(profiler.get_summary())
        print("="*50 + "\n")
    
    def on_toggle_event_monitor():
        """Ctrl+Shift+E: 이벤트 모니터 토글"""
        # 구현...
        pass
    
    keyboard.add_hotkey('ctrl+shift+d', on_dump_now)
    keyboard.add_hotkey('ctrl+shift+r', on_show_profile)
    keyboard.add_hotkey('ctrl+shift+e', on_toggle_event_monitor)
    
    print("[DEBUG] 디버그 단축키 활성화:")
    print("  Ctrl+Shift+D: 즉시 덤프")
    print("  Ctrl+Shift+R: 프로파일 요약")
    print("  Ctrl+Shift+E: 이벤트 모니터 토글")
```

---

## Phase 4: 통합 테스트

### 테스트 시나리오

| # | 시나리오 | 예상 동작 | 확인 항목 |
|---|----------|----------|----------|
| 1 | `--debug` 없이 실행 | 도구 비활성 | 로그 최소, 덤프 없음 |
| 2 | `--debug`로 실행 | 도구 활성 | 상세 로그 출력 |
| 3 | 메뉴 열기 실패 | 자동 덤프 | `auto_menu_fail_*.txt` 생성 |
| 4 | 500ms 초과 작업 | 자동 덤프 | `auto_slow_*.txt` 생성 |
| 5 | 빈 리스트 감지 | 자동 덤프 | `auto_empty_list_*.txt` 생성 |
| 6 | 정상 종료 | 세션 리포트 | `session_*_report.md` 생성 |
| 7 | Ctrl+Shift+D | 수동 덤프 | `manual_*.txt` 생성 |

### 테스트 명령어

```bash
# 1. 일반 모드 (도구 비활성)
python -m kakaotalk_a11y_client.main

# 2. 디버그 모드
python -m kakaotalk_a11y_client.main --debug

# 3. 프로파일러만
python -m kakaotalk_a11y_client.main --debug-profile

# 4. 시작 덤프 포함
python -m kakaotalk_a11y_client.main --debug --debug-dump-on-start

# 5. 이벤트 모니터 포함 (오버헤드 주의)
python -m kakaotalk_a11y_client.main --debug --debug-events
```

---

## 최종 산출물

1. **수정 파일**
   - `config.py` 또는 `utils/debug_config.py`: 디버그 설정
   - `main.py`: CLI 인자 처리, 디버그 초기화
   - `utils/debug_tools.py`: 디버그 도구 통합 관리자

2. **통합 대상 파일** (기존 코드에 `debug_tools` 연동)
   - ~~`navigation/context_menu.py`~~ [폐기됨]
   - `navigation/chat_list.py`
   - `navigation/chat_room.py`
   - `core/focus_monitor.py`
   - (기타 주요 모듈)

3. **선택 파일**
   - `utils/debug_commands.py`: 실시간 디버그 단축키

---

## 체크리스트

```
□ DebugConfig 클래스 구현
□ CLI --debug 옵션 추가
□ DebugToolManager 구현
  □ debug_operation 컨텍스트 매니저
  □ dump_on_condition 메서드
  □ 자동 덤프 로직
□ 주요 모듈에 debug_tools 연동
  ☒ ~~context_menu.py~~ [폐기됨]
  □ chat_list.py
  □ chat_room.py
  □ focus_monitor.py
□ 세션 리포트 생성
□ (선택) 디버그 단축키
□ 테스트 시나리오 수행
```

---

## 주의사항

1. **성능 오버헤드**: 디버그 모드는 성능 저하 있음. 프로덕션에서는 비활성화.
2. **디스크 사용량**: 자동 덤프가 많이 쌓일 수 있음. 주기적 정리 필요.
3. **기존 코드 최소 변경**: `with debug_tools.debug_operation()` 래핑만 추가, 기존 로직 변경 X.
4. **카카오톡 한정**: 모든 덤프/분석은 카카오톡 창만 대상 (기존 도구 제약 유지).
